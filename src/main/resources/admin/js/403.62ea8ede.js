"use strict";(self["webpackChunkhalo_admin"]=self["webpackChunkhalo_admin"]||[]).push([[403],{52403:function(t,e,o){o.r(e),o.d(e,{default:function(){return w}});var n=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("page-view",{attrs:{"sub-title":t.postToStage.inProgress?"当前内容已保存，但还未发布。":"",title:t.postToStage.title?t.postToStage.title:"新文章",affix:""}},[o("template",{slot:"extra"},[o("a-space",[o("a-button",{attrs:{loading:t.previewSaving},on:{click:t.handlePreviewClick}},[t._v("预览")]),o("a-button",{attrs:{type:"primary"},on:{click:function(e){t.postSettingVisible=!0}}},[t._v("发布")])],1)],1),o("a-row",{attrs:{gutter:12}},[o("a-col",{attrs:{span:24}},[o("div",{staticClass:"mb-4"},[o("a-input",{attrs:{placeholder:"请输入文章标题",size:"large"},model:{value:t.postToStage.title,callback:function(e){t.$set(t.postToStage,"title",e)},expression:"postToStage.title"}})],1),o("div",{style:{height:t.editorHeight},attrs:{id:"editor"}},[o("MarkdownEditor",{attrs:{originalContent:t.postToStage.originalContent},on:{"update:originalContent":function(e){return t.$set(t.postToStage,"originalContent",e)},"update:original-content":function(e){return t.$set(t.postToStage,"originalContent",e)},change:t.onContentChange,save:function(e){return t.handleSaveDraft()}}})],1)])],1),o("PostSettingModal",{attrs:{post:t.postToStage,savedCallback:t.onPostSavedCallback,visible:t.postSettingVisible},on:{"update:visible":function(e){t.postSettingVisible=e},onUpdate:t.onUpdateFromSetting}})],2)},a=[],s=o(92158),i=o(26815),r=o(50990),l=o(3832),d=o(86637),h=o(1540),g=o(86763),p=o.n(g),c={mixins:[l.jB,l.KT,l.g3],components:{PostSettingModal:s.Z,MarkdownEditor:i.Z,PageView:r.B4},data(){return{postSettingVisible:!1,postToStage:{},contentChanges:0,previewSaving:!1}},beforeRouteEnter(t,e,o){const n=t.query.postId;o((async t=>{if(n){const{data:e}=await h.Z.post.get(Number(n));t.postToStage=e}}))},destroyed(){window.onbeforeunload&&(window.onbeforeunload=null)},beforeRouteLeave(t,e,o){const n=this.$createElement;this.contentChanges<=1?o():this.$confirm({title:"当前页面数据未保存，确定要离开吗？",content:()=>n("div",{style:"color:red;"},["如果离开当面页面，你的数据很可能会丢失！"]),onOk(){o()},onCancel(){o(!1)}})},mounted(){window.onbeforeunload=function(t){return t=t||window.event,t&&(t.returnValue="当前页面数据未保存，确定要离开吗？"),"当前页面数据未保存，确定要离开吗？"}},beforeMount(){document.addEventListener("keydown",this.onRegisterSaveShortcut)},beforeDestroy(){document.removeEventListener("keydown",this.onRegisterSaveShortcut)},methods:{onRegisterSaveShortcut(t){!t.ctrlKey&&!t.metaKey||t.altKey||t.shiftKey||83!==t.keyCode||(t.preventDefault(),t.stopPropagation(),this.handleSaveDraft())},handleSaveDraft:p()((async function(){if(this.postToStage.id)try{const{data:t}=await h.Z.post.updateDraftById(this.postToStage.id,this.postToStage.originalContent,this.postToStage.content,!0);this.postToStage.inProgress=t.inProgress,this.handleRestoreSavedStatus(),this.$message.success({content:"内容已保存",duration:.5})}catch(t){this.$log.error("Failed to update post content",t)}else await this.handleCreatePost()}),300),async handleCreatePost(){this.postToStage.title||(this.postToStage.title=(0,d._)(new Date,"YYYY-MM-DD-HH-mm-ss"));try{this.postToStage.keepRaw=!0;const{data:t}=await h.Z.post.create(this.postToStage);this.postToStage=t,this.handleRestoreSavedStatus();const e=this.$router.history.current.path;this.$router.push({path:e,query:{postId:this.postToStage.id}}).catch((t=>t)),this.$message.success({content:"文章已创建",duration:.5})}catch(t){this.$log.error("Failed to create post",t)}},async handlePreviewClick(){if(this.previewSaving=!0,this.postToStage.id){const{data:t}=await h.Z.post.updateDraftById(this.postToStage.id,this.postToStage.originalContent,this.postToStage.content,!0);this.postToStage.inProgress=t.inProgress}else await this.handleCreatePost();await this.handleOpenPreview()},async handleOpenPreview(){try{const t=await h.Z.post.getPreviewLinkById(this.postToStage.id);window.open(t,"_blank"),this.handleRestoreSavedStatus()}catch(t){this.$log.error("Failed to get preview link",t)}finally{setTimeout((()=>{this.previewSaving=!1}),400)}},handleRestoreSavedStatus(){this.contentChanges=0},onContentChange({originalContent:t,renderContent:e}){this.contentChanges++,this.postToStage.originalContent=t,this.postToStage.content=e},onPostSavedCallback(){this.contentChanges=0,this.$router.push({name:"PostList"})},onUpdateFromSetting(t){this.postToStage=t}}},u=c,S=o(18156),v=(0,S.Z)(u,n,a,!1,null,null,null),w=v.exports}}]);