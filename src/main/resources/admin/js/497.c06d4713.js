"use strict";(self["webpackChunkhalo_admin"]=self["webpackChunkhalo_admin"]||[]).push([[497],{5497:function(e,t,a){a.r(t),a.d(t,{default:function(){return S}});var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("page-view",[a("a-row",{attrs:{gutter:12}},[a("a-col",{staticClass:"pb-3",attrs:{lg:8,md:8,sm:24,xl:8,xs:24}},[a("a-card",{attrs:{bodyStyle:{padding:"16px"},"head-style":{padding:"8px 16px!important"},title:e.title}},[a("a-form-model",{ref:"categoryForm",attrs:{model:e.form.model,rules:e.form.rules,layout:"horizontal"}},[a("a-form-model-item",{attrs:{help:"* 页面上所显示的名称",label:"名称：",prop:"name"}},[a("a-input",{ref:"nameInput",model:{value:e.form.model.name,callback:function(t){e.$set(e.form.model,"name",t)},expression:"form.model.name"}})],1),a("a-form-model-item",{attrs:{help:"* 一般为单个分类页面的标识，最好为英文",label:"别名：",prop:"slug"}},[a("a-input",{model:{value:e.form.model.slug,callback:function(t){e.$set(e.form.model,"slug",t)},expression:"form.model.slug"}})],1),a("a-form-model-item",{attrs:{label:"上级目录：",prop:"parentId"}},[a("category-select-tree",{attrs:{categories:e.list.data,"category-id":e.form.model.parentId},on:{"update:categoryId":function(t){return e.$set(e.form.model,"parentId",t)},"update:category-id":function(t){return e.$set(e.form.model,"parentId",t)}}})],1),a("a-form-model-item",{attrs:{help:"* 在分类页面可展示，需要主题支持",label:"封面图：",prop:"thumbnail"}},[a("AttachmentInput",{attrs:{title:"选择封面图"},model:{value:e.form.model.thumbnail,callback:function(t){e.$set(e.form.model,"thumbnail",t)},expression:"form.model.thumbnail"}})],1),a("a-form-model-item",{attrs:{help:"* 分类密码",label:"密码：",prop:"password"}},[a("a-input-password",{attrs:{autocomplete:"new-password"},model:{value:e.form.model.password,callback:function(t){e.$set(e.form.model,"password",t)},expression:"form.model.password"}})],1),a("a-form-model-item",{attrs:{help:"* 分类描述，需要主题支持",label:"描述：",prop:"description"}},[a("a-input",{attrs:{autoSize:{minRows:3},type:"textarea"},model:{value:e.form.model.description,callback:function(t){e.$set(e.form.model,"description",t)},expression:"form.model.description"}})],1),a("a-form-model-item",[e.isUpdateMode?a("a-button-group",[a("ReactiveButton",{attrs:{errored:e.form.errored,loading:e.form.saving,erroredText:"更新失败",loadedText:"更新成功",text:"更新",type:"primary"},on:{callback:e.handleSavedCallback,click:e.handleCreateOrUpdateCategory}}),a("a-button",{attrs:{type:"dashed"},on:{click:function(t){e.form.model={}}}},[e._v("返回添加")])],1):a("ReactiveButton",{attrs:{errored:e.form.errored,loading:e.form.saving,erroredText:"保存失败",loadedText:"保存成功",text:"保存",type:"primary"},on:{callback:e.handleSavedCallback,click:e.handleCreateOrUpdateCategory}})],1)],1)],1)],1),a("a-col",{staticClass:"pb-3",attrs:{lg:16,md:16,sm:24,xl:16,xs:24}},[a("a-card",{attrs:{bodyStyle:{padding:"16px"},title:"分类列表"},scopedSlots:e._u([{key:"extra",fn:function(){return[a("ReactiveButton",{attrs:{disabled:e.list.data.length<=0,errored:e.formBatch.errored,loading:e.formBatch.saving,erroredText:"保存失败",loadedText:"保存成功",text:"保存"},on:{callback:function(t){e.formBatch.errored=!1},click:e.handleUpdateBatch}})]},proxy:!0}])},[a("a-spin",{attrs:{spinning:e.list.loading}},[a("CategoryTreeNode",{on:{edit:e.handleEdit,reload:e.handleListCategories,select:e.handleSelect},model:{value:e.list.treeData,callback:function(t){e.$set(e.list,"treeData",t)},expression:"list.treeData"}})],1)],1)],1)],1)],1)},o=[],l=a(50990),s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("a-tree-select",{attrs:{allowClear:!0,treeData:e.categoryTreeData,treeDataSimpleMode:!0,placeholder:"请选择上级目录，默认为顶级目录",treeDefaultExpandAll:""},model:{value:e.categoryIdString,callback:function(t){e.categoryIdString=t},expression:"categoryIdString"}})},i=[],n={name:"CategorySelectTree",props:{categoryId:{type:Number,required:!0,default:0},categories:{type:Array,required:!1,default:()=>[]}},computed:{categoryTreeData(){return[{id:0,title:"根目录",value:"0",pId:-1},...this.categories.map((e=>({id:e.id,title:e.name,value:e.id.toString(),pId:e.parentId})))]},categoryIdString:{get(){return this.categoryId.toString()},set(e){this.$emit("update:categoryId",e?parseInt(e):0)}}}},d=n,c=a(18156),m=(0,c.Z)(d,s,i,!1,null,null,null),u=m.exports,p=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("a-list",{attrs:{"item-layout":"horizontal"}},[a("draggable",e._b({staticClass:"item-container",attrs:{list:e.list,value:e.value,handle:".mover",tag:"div"},on:{end:function(t){e.isDragging=!1},input:e.emitter,start:function(t){e.isDragging=!0}}},"draggable",{animation:300,group:"description",ghostClass:"ghost",chosenClass:"chosen",dragClass:"drag",emptyInsertThreshold:20},!1),[a("transition-group",e._l(e.realValue,(function(t){return a("div",{key:t.id},[a("a-list-item",{staticClass:"menu-item",scopedSlots:e._u([{key:"actions",fn:function(){return[a("a-button",{staticClass:"!p-0",attrs:{type:"link"},on:{click:function(a){return e.handleSelect(t)}}},[e._v("新增")]),a("a-button",{staticClass:"!p-0",attrs:{type:"link"},on:{click:function(a){return e.handleEdit(t)}}},[e._v("编辑")]),a("a-button",{staticClass:"!p-0",attrs:{type:"link"},on:{click:function(a){return e.handleDelete(t)}}},[e._v("删除")])]},proxy:!0}],null,!0)},[a("a-list-item-meta",[a("span",{staticClass:"inline-block font-bold title",attrs:{slot:"title"},slot:"title"},[a("a-icon",{staticClass:"cursor-move mover mr-1",attrs:{type:"bars"}}),e._v(" "+e._s(t.name)+e._s(t.hasPassword?"（加密）":"")+" ")],1),a("span",{staticClass:"inline-block",attrs:{slot:"description"},slot:"description"},[a("a",{staticClass:"ant-anchor-link-title",attrs:{href:t.fullPath,target:"_blank"}},[e._v(" "+e._s(t.fullPath)+" ")])])])],1),a("div",{staticClass:"a-list-nested",staticStyle:{"margin-left":"44px"}},[a("CategoryTreeNode",{attrs:{list:t.children},on:{edit:e.handleEdit,reload:function(t){return e.$emit("reload")},select:e.handleSelect}})],1)],1)})),0)],1)],1)},h=[],g=a(77513),f=a.n(g),y=a(1540),v={name:"CategoryTreeNode",components:{draggable:f()},props:{value:{required:!1,type:Array,default:null},list:{required:!1,type:Array,default:null}},computed:{realValue(){return this.value?this.value:this.list}},data(){return{isDragging:!1}},methods:{emitter(e){this.$emit("input",e)},handleDelete(e){const t=this;t.$confirm({title:"提示",content:`确定要删除名为${e.name}的分类？`,async onOk(){try{await y.Z.category["delete"](e.id),t.$emit("reload")}catch(a){t.$log.error("Fail to delete category",a)}}})},handleEdit(e){this.$emit("edit",e)},handleSelect(e){this.$emit("select",e)}}},b=v,C=(0,c.Z)(b,p,h,!1,null,"56da7354",null),x=C.exports,k=a(3832),I={components:{PageView:l.B4,CategorySelectTree:u,CategoryTreeNode:x},mixins:[k.jB,k.KT],data(){return{list:{data:[],treeData:[],loading:!1},form:{model:{},saving:!1,errored:!1,rules:{name:[{required:!0,message:"* 分类名称不能为空",trigger:["change"]},{max:255,message:"* 分类名称的字符长度不能超过 255",trigger:["change"]}],slug:[{max:255,message:"* 分类别名的字符长度不能超过 255",trigger:["change"]}],thumbnail:[{max:1023,message:"* 封面图链接的字符长度不能超过 1023",trigger:["change"]}],description:[{max:100,message:"* 分类描述的字符长度不能超过 100",trigger:["change"]}]}},formBatch:{saving:!1,errored:!1}}},computed:{title(){return this.isUpdateMode?"修改分类":"添加分类"},isUpdateMode(){return!!this.form.model.id}},created(){this.handleListCategories()},methods:{async handleListCategories(){try{this.list.loading=!0;const{data:e}=await y.Z.category.list({});this.list.data=e,this.list.treeData=this.convertDataToTree(e)}catch(e){this.$log.error("Failed to get categories",e)}finally{this.list.loading=!1}},convertDataToTree(e){const t={},a=[];return e.forEach((e=>t[e.id]={...e,children:[]})),e.forEach((e=>{const r=t[e.id],o=t[e.parentId];r.password&&(r.hasPassword=!0),o&&(o.password||o.hasPassword)&&(r.hasPassword=!0),e.parentId?t[e.parentId].children.push(r):a.push(r)})),a},async handleEdit(e){try{const{data:t}=await y.Z.category.get(e.id);this.form.model=t,this.$refs.nameInput.focus()}catch(t){this.$log.error("Failed to get category",t)}},handleSelect(e){this.form.model={parentId:e.id},this.$refs.nameInput.focus()},handleCreateOrUpdateCategory(){const e=this;e.$refs.categoryForm.validate((t=>{t&&(e.form.saving=!0,e.isUpdateMode?y.Z.category.update(e.form.model.id,e.form.model).catch((()=>{this.form.errored=!0})).finally((()=>{setTimeout((()=>{e.form.saving=!1}),400)})):y.Z.category.create(this.form.model).catch((()=>{this.form.errored=!0})).finally((()=>{setTimeout((()=>{e.form.saving=!1}),400)})))}))},async handleUpdateBatch(){const e=(t,a=0)=>t&&0!==t.length?t.reduce(((t,r,o)=>{r.priority=o+1,r.parentId=a;const l=r.children.length>0?e(r.children,r.id):[];return[...t,r,...l]}),[]):[],t=e(this.list.treeData);try{this.formBatch.saving=!0,await y.Z.category.updateInBatch(t)}catch(a){this.formBatch.errored=!0,this.$log.error("Failed to update categories",a)}finally{setTimeout((()=>{this.formBatch.saving=!1,this.handleListCategories()}),400)}},handleSavedCallback(){if(this.form.errored)this.form.errored=!1;else{const e=this;e.form.model={},e.handleListCategories()}},handleQueryCategoryPosts(e){this.$router.push({name:"PostList",query:{categoryId:e.id}})}}},$=I,w=(0,c.Z)($,r,o,!1,null,null,null),S=w.exports}}]);